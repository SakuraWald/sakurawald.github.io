<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"sakurawald.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Advanced SQLAccess DB From PL通过 编程语言 (Programming Language) 访问 数据库 的方式：  动态SQL：使用 数据库API 来连接 数据库  JDBC ODBC ADO.NET   嵌入式SQL：可以将 SQL语句 嵌入到 宿主语言 中，通过 预处理器 对 嵌入宿主语言的SQL 进行 转化。    这里简单地讨论几点 JDBC 的内容。  主要">
<meta property="og:type" content="article">
<meta property="og:title" content="Dtabase - Advanced SQL">
<meta property="og:url" content="https://sakurawald.github.io/2022/04/29/database-advanced-sql/index.html">
<meta property="og:site_name" content="SakuraWald">
<meta property="og:description" content="Advanced SQLAccess DB From PL通过 编程语言 (Programming Language) 访问 数据库 的方式：  动态SQL：使用 数据库API 来连接 数据库  JDBC ODBC ADO.NET   嵌入式SQL：可以将 SQL语句 嵌入到 宿主语言 中，通过 预处理器 对 嵌入宿主语言的SQL 进行 转化。    这里简单地讨论几点 JDBC 的内容。  主要">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-04-29T21:35:25.000Z">
<meta property="article:modified_time" content="2023-01-01T23:38:44.219Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://sakurawald.github.io/2022/04/29/database-advanced-sql/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>Dtabase - Advanced SQL | SakuraWald</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">SakuraWald</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://sakurawald.github.io/2022/04/29/database-advanced-sql/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SakuraWald">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Dtabase - Advanced SQL
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-04-29 21:35:25" itemprop="dateCreated datePublished" datetime="2022-04-29T21:35:25+00:00">2022-04-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-01-01 23:38:44" itemprop="dateModified" datetime="2023-01-01T23:38:44+00:00">2023-01-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/uncategorized/" itemprop="url" rel="index"><span itemprop="name">uncategorized</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Advanced-SQL"><a href="#Advanced-SQL" class="headerlink" title="Advanced SQL"></a>Advanced SQL</h1><h2 id="Access-DB-From-PL"><a href="#Access-DB-From-PL" class="headerlink" title="Access DB From PL"></a>Access DB From PL</h2><p>通过 <code>编程语言 (Programming Language)</code> <code>访问</code> <code>数据库</code> 的方式：</p>
<ul>
<li><p><code>动态SQL</code>：使用 <code>数据库API</code> 来连接 <code>数据库</code></p>
<ul>
<li>JDBC</li>
<li>ODBC</li>
<li>ADO.NET</li>
</ul>
</li>
<li><p><code>嵌入式SQL</code>：可以将 <code>SQL语句</code> 嵌入到 <code>宿主语言</code> 中，通过 <code>预处理器</code> 对 <code>嵌入宿主语言的SQL</code> 进行 <code>转化</code>。</p>
</li>
</ul>
<hr>
<p>这里简单地讨论几点 <code>JDBC</code> 的内容。</p>
<ul>
<li><p>主要涉及的对象：<code>Connection</code>，<code>Statement</code>，<code>ResultSet</code></p>
</li>
<li><p><code>JDBC</code> 并不是仅仅支持 <code>MySQL</code> 的，它可以 <code>指定</code> 用于 <code>建立数据库连接</code> 的 <code>数据库通信的API</code>：如 <code>jdbc:mysql</code>，<code>jdbc:oracle</code> 等来连接 <code>多种类型的数据库</code></p>
<blockquote>
<p>更准确地说，<code>JDBC</code> 仅 <code>指定通信所用的API</code>，而不是 <code>指定通信所用的协议</code>。因为一个<code>JDBC驱动器</code> 可能同时支持 <code>多种数据库通信协议</code></p>
</blockquote>
</li>
<li><p><code>Statement</code> 并不是 <code>SQL语句对象</code>本身，但可以用 <code>Statement</code> 来 <code>执行语句</code></p>
</li>
<li><p>使用 <code>PreparedStatement</code> 而不是 <code>拼接字符串的方式</code> 来 <code>构造SQL语句</code>！</p>
</li>
<li><p><code>数据库</code> 返回的 <code>ResultSet</code> 不仅仅包含 <code>元组数据</code>，还包含许多 <code>元数据</code>。在需要时使用 <code>ResultSet#getMetaData</code> 获得 <code>元数据</code>，而不是 <code>硬编码</code> 它们！</p>
</li>
<li><p>对 <code>Updatable Result Set</code> 的 <code>修改性操作</code> 会 <code>反映到数据库</code></p>
</li>
<li><p>如果需要将 <code>接下来的多条SQL语句作为事务</code>，而不是 <code>每条语句都被视为独立的事务</code>，则请用 <code>Connection#setAutoCommit(false)</code></p>
</li>
</ul>
<h2 id="Function-and-Procedure"><a href="#Function-and-Procedure" class="headerlink" title="Function and Procedure"></a>Function and Procedure</h2><p><code>函数 (Function)</code> 和 <code>过程 (Procedure)</code> 允许 <code>业务逻辑</code> 作为 <code>存储过程</code> 记录在 <code>数据中</code>。</p>
<p>这使得 <code>业务逻辑代码</code> 是 <code>编程语言独立</code> 和 <code>应用独立</code> 的。</p>
<h3 id="Function"><a href="#Function" class="headerlink" title="Function"></a>Function</h3><ul>
<li>一个简单的 <code>函数</code> 的例子</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> dept_count(dept_name <span class="type">varchar</span>(<span class="number">20</span>)) <span class="keyword">RETURNS</span> <span class="type">integer</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> d_count <span class="type">integer</span></span><br><span class="line">    <span class="keyword">SELECT</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">INTO</span> d_count</span><br><span class="line">    <span class="keyword">FROM</span> instructor</span><br><span class="line">    <span class="keyword">WHERE</span> instructor.dept_name <span class="operator">=</span> dept_name</span><br><span class="line">    <span class="keyword">RETURN</span> d_count</span><br><span class="line"><span class="keyword">END</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>带参数的视图 (Parameterized View)</code></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> instructor_of(dept_name <span class="type">varchar</span>(<span class="number">20</span>)) <span class="keyword">RETURNS</span> <span class="keyword">TABLE</span>(ID <span class="type">varchar</span>(<span class="number">5</span>),</span><br><span class="line">                                                                  name <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">                                                                  dept_name <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">                                                                  salary <span class="type">numeric</span>(<span class="number">8</span>,<span class="number">2</span>))</span><br><span class="line"><span class="keyword">RETURN</span> <span class="keyword">TABLE</span>(<span class="keyword">SELECT</span> ID, name, dept_name, salary</span><br><span class="line">             <span class="keyword">FROM</span> instructor</span><br><span class="line">             <span class="keyword">WHERE</span> instructor.dept_name <span class="operator">=</span> instructor_of.dept_name</span><br><span class="line">            );                                                                 </span><br></pre></td></tr></table></figure>

<p>我们将 <code>这种函数</code> 视为 <code>广义上的视图</code>。</p>
<h3 id="Procedure"><a href="#Procedure" class="headerlink" title="Procedure"></a>Procedure</h3><blockquote>
<p>对于 <code>函数 (Function)</code> 和 <code>过程 (Procedure)</code> 如果做 <code>详细区分</code>，则我们这样定义：</p>
<ul>
<li>函数：带有 <code>返回值</code></li>
<li>过程：不带有 <code>返回值</code></li>
</ul>
<p>从 <code>组成体系结构</code> 的角度看，<code>过程</code> 是比 <code>函数</code> 更加 <code>底层的概念</code></p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> dept_count_proc(<span class="keyword">IN</span> dept_name <span class="type">varchar</span>(<span class="number">20</span>), <span class="keyword">OUT</span> d_count <span class="type">integer</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">SELECT</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">INTO</span> d_count</span><br><span class="line">    <span class="keyword">FROM</span> instructor</span><br><span class="line">    <span class="keyword">WHERE</span> instructor.dept_name <span class="operator">=</span> dept_count_proc.dept_name</span><br><span class="line"><span class="keyword">END</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>IN</code> 表示 <code>输入参数</code>，而 <code>OUT 表示输出参数</code>。</p>
<p>这种形式的 <code>传参方式</code> 在某些 <code>底层接口调用</code> 中常见。其中 <code>OUT</code> 经常传递的是 <code>指针类型</code>，以便 <code>调用者</code> 可以通过 <code>变量</code> 来 <code>接收</code> 到 <code>过程的结果</code></p>
</blockquote>
<h3 id="Persistent-Storage-Module"><a href="#Persistent-Storage-Module" class="headerlink" title="Persistent Storage Module"></a>Persistent Storage Module</h3><p><code>持久存储模块 (Persistent Storage Module)</code> ：用于处理 <code>构造</code></p>
<p>这里不详细讨论 <code>PSM</code> 的 <code>语法</code>，只给出一个 <code>大号的例子</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DECLARE</span> out_of_classroom_seats <span class="keyword">CONDITION</span></span><br><span class="line"><span class="keyword">DECLARE</span> EXIT HANDLER <span class="keyword">FOR</span> out_of_classroom_seats</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">sequence <span class="keyword">of</span> statements</span><br><span class="line"><span class="keyword">END</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> registerStudnet(</span><br><span class="line">    <span class="keyword">IN</span> s_id <span class="type">varchar</span>(<span class="number">5</span>),</span><br><span class="line">    <span class="keyword">IN</span> s_courseid <span class="type">varchar</span>(<span class="number">8</span>),</span><br><span class="line">    <span class="keyword">IN</span> s_secid <span class="type">varchar</span>(<span class="number">8</span>),</span><br><span class="line">    <span class="keyword">IN</span> s_semester <span class="type">varchar</span>(<span class="number">6</span>),</span><br><span class="line">    <span class="keyword">IN</span> s_year <span class="type">numeric</span>(<span class="number">4</span>,<span class="number">0</span>),</span><br><span class="line">    <span class="keyword">OUT</span> errorMsg <span class="type">varchar</span>(<span class="number">100</span>)</span><br><span class="line"><span class="keyword">RETURNS</span> <span class="type">integer</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> currEnrol <span class="type">int</span>;</span><br><span class="line">    <span class="keyword">SELECT</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">INTO</span> currEnrol</span><br><span class="line">    <span class="keyword">FROM</span> takes</span><br><span class="line">    <span class="keyword">WHERE</span> course_id <span class="operator">=</span> s_courseid <span class="keyword">AND</span> sec_id <span class="operator">=</span> s_secid</span><br><span class="line">    <span class="keyword">AND</span> semester <span class="operator">=</span> s_semester <span class="keyword">AND</span> <span class="keyword">year</span> <span class="operator">=</span> s_year;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">DECLARE</span> limit <span class="type">int</span>;</span><br><span class="line">    <span class="keyword">SELECT</span> capacity <span class="keyword">INTO</span> limit</span><br><span class="line">    <span class="keyword">FROM</span> capacity <span class="keyword">NATURAL</span> <span class="keyword">JOIN</span> section</span><br><span class="line">    <span class="keyword">WHERE</span> course_id <span class="operator">=</span> s_courseid <span class="keyword">AND</span> sec_id <span class="operator">=</span> s_secid</span><br><span class="line">    <span class="keyword">AND</span> semester <span class="operator">=</span> s_semester <span class="keyword">AND</span> <span class="keyword">year</span> <span class="operator">=</span> s_year;</span><br><span class="line">    </span><br><span class="line">    IF (currEnrol <span class="operator">&lt;</span> limit) </span><br><span class="line">    <span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">INSERT</span> <span class="keyword">INTO</span> takes <span class="keyword">VALUES</span> (s_id, s_courseid, s_secid, s_semester, s_year, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">RETURN</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">END</span></span><br><span class="line">    <span class="comment">-- capacity overflow !</span></span><br><span class="line">    <span class="keyword">SET</span> errorMsg <span class="operator">=</span> <span class="string">&#x27;Enrollment limit reached for course&#x27;</span>  s_courseid  <span class="string">&#x27;section&#x27;</span>  s_secid;</span><br><span class="line">    <span class="keyword">RETURN</span>(<span class="number">-1</span>);</span><br><span class="line"><span class="keyword">END</span>    </span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="External-Language-Procedure"><a href="#External-Language-Procedure" class="headerlink" title="External Language Procedure"></a>External Language Procedure</h3><p><code>数据库</code> 可以将 <code>过程</code> 委托给 <code>外部语言程序</code> 来执行，像这样的 <code>过程</code> 称作 <code>外部语言过程</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> dept_count_proc(<span class="keyword">IN</span> dept_name <span class="type">varchar</span>(<span class="number">20</span>), <span class="keyword">OUT</span> count <span class="type">integer</span>)</span><br><span class="line"><span class="keyword">LANGUAGE</span> C</span><br><span class="line"><span class="keyword">EXTERNAL</span> NAME <span class="string">&#x27;/usr/avi/bin/dept_course_proc&#x27;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果为了 <code>性能</code> 而将 <code>任务</code> 委托给 <code>C</code> 这样的语言，可能会导致 <code>安全问题</code>。</p>
<p>而如果委托给 <code>Java</code>，<code>C#</code> 这样的语言，通过 <code>进程间通信</code> 和 <code>沙盒执行</code> 则会导致 <code>效率低下</code>。</p>
<p>此外，编写能 <code>正确处理</code> <code>数据库数据</code> 的 <code>外部例程</code> 的 <code>编码量</code> 通常较多。</p>
</blockquote>
<h2 id="Trigger"><a href="#Trigger" class="headerlink" title="Trigger"></a>Trigger</h2><p><code>触发器 (Trigger)</code>：用于在 <code>数据库</code> 发生 <code>指定事件</code> 时，<code>自动</code> 被 <code>执行的语句</code></p>
<hr>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> credits_earned AFTER <span class="keyword">UPDATE</span> <span class="keyword">OF</span> takes <span class="keyword">ON</span>(grade)</span><br><span class="line"><span class="keyword">REFERENCING</span> <span class="keyword">NEW</span> <span class="type">ROW</span> <span class="keyword">AS</span> nrow</span><br><span class="line"><span class="keyword">REFERENCING</span> <span class="keyword">OLD</span> <span class="type">ROW</span> <span class="keyword">AS</span> orow</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span></span><br><span class="line"><span class="keyword">WHEN</span> nrow.grade <span class="operator">&lt;&gt;</span> <span class="string">&#x27;F&#x27;</span> <span class="keyword">AND</span> nrow.grade <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line"><span class="keyword">AND</span> (orow.grade <span class="operator">=</span> <span class="string">&#x27;F&#x27;</span> <span class="keyword">OR</span> orow.grade <span class="keyword">IS</span> <span class="keyword">NULL</span>)</span><br><span class="line"><span class="keyword">BEGIN</span> <span class="keyword">ATOMIC</span></span><br><span class="line"><span class="keyword">UPDATE</span> student</span><br><span class="line"><span class="keyword">SET</span> tot_cred <span class="operator">=</span> tot_cred <span class="operator">+</span> </span><br><span class="line">            (<span class="keyword">SELECT</span> credits</span><br><span class="line">            <span class="keyword">FROM</span> course</span><br><span class="line">            <span class="keyword">WHERE</span> course.course_id <span class="operator">=</span> nrow.course_id)</span><br><span class="line">    <span class="keyword">WHERE</span> student.id <span class="operator">=</span> nrow.id;</span><br><span class="line">    <span class="keyword">END</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>触发器类型</code>：</p>
<ul>
<li><code>语句级触发器 (FOR EACH STATEMENT)</code>：对于 <code>引起修改的整个SQL语句</code> <code>仅执行1次</code> <code>触发器</code></li>
<li><code>行级触发器 (FOR EACH ROW)</code>：对 <code>每个受影响的行</code> <code>都执行1次</code> <code>触发器</code></li>
</ul>
<p><code>过渡变量 (Transition Variable)</code>：</p>
<ul>
<li><code>REFERENCING OLD ROW AS symbol</code>：存储 <code>已经更新或删除的行的旧值</code></li>
<li><code>REFERENCING NEW ROW AS symbol</code>：可用于 <code>插入</code> 或 <code>删除</code> 的 <code>行的引用</code></li>
</ul>
<p><code>触发时机</code>：</p>
<ul>
<li><code>BEFORE</code>：用于 <code>避免非法更新</code>，<code>附加额外约束</code></li>
<li><code>AFTER</code>：用于 <code>为某些修改做善后处理</code>，<code>维护某些修改性操作的合法性</code></li>
</ul>
</blockquote>
<p>如果可以使用 <code>存储过程</code> 的话，则尽量不要使用 <code>触发器</code>。</p>
<h2 id="Recursive-Query"><a href="#Recursive-Query" class="headerlink" title="Recursive Query"></a>Recursive Query</h2><p><code>递归查询 (Recursive Query)</code> 的典型例子是寻找 <code>传递闭包 (Transitive Closure)</code> ，比如 <code>找出某个课程的所有前置课程</code>。</p>
<hr>
<p>寻找 <code>传递闭包</code></p>
<h3 id="Iteration"><a href="#Iteration" class="headerlink" title="Iteration"></a>Iteration</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> findAllPrereqs(cid <span class="type">varchar</span>(<span class="number">8</span>))</span><br><span class="line"><span class="keyword">RETURN</span> <span class="keyword">TABLE</span>(course_id <span class="type">varchar</span>(<span class="number">8</span>))</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="comment">-- define variables</span></span><br><span class="line"><span class="keyword">CREATE</span> TEMPORARY <span class="keyword">TABLE</span> c_prereq(course_id <span class="type">varchar</span>(<span class="number">8</span>));</span><br><span class="line"><span class="keyword">CREATE</span> TEMPORARY <span class="keyword">TABLE</span> new_c_prereq(course_id <span class="type">varchar</span>(<span class="number">8</span>));</span><br><span class="line"><span class="keyword">CREATE</span> TEMPORARY <span class="keyword">TABLE</span> temp(course_id <span class="type">varchar</span>(<span class="number">8</span>));</span><br><span class="line"><span class="comment">-- init and continue</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> new_c_prereq</span><br><span class="line"><span class="keyword">SELECT</span> prereq_id</span><br><span class="line"><span class="keyword">FROM</span> prereq</span><br><span class="line"><span class="keyword">WHERE</span> course_id <span class="operator">=</span> cid;</span><br><span class="line"><span class="comment">-- loop until not new course is added</span></span><br><span class="line">REPEAT</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> c_prereq</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">INTO</span> temp</span><br><span class="line"><span class="keyword">FROM</span> new_c_prereq;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> temp</span><br><span class="line">(<span class="keyword">SELECT</span> prereq.course_id</span><br><span class="line">            <span class="keyword">FROM</span> new_C_prereq, prereq</span><br><span class="line">            <span class="keyword">WHERE</span> new_c_prereq.course_id <span class="operator">=</span> prereq.course_id)</span><br><span class="line">            <span class="keyword">EXCEPT</span></span><br><span class="line">            (<span class="keyword">SELECT</span> course_id</span><br><span class="line">            <span class="keyword">FROM</span> c_prereq);</span><br><span class="line">        <span class="keyword">DELETE</span> <span class="keyword">FROM</span> new_c_prereq;</span><br><span class="line">        <span class="keyword">INSERT</span> <span class="keyword">INTO</span> new_c_prereq</span><br><span class="line">        <span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> temp;</span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> temp;</span><br><span class="line">UNTIL <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> (<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> new_c_prereq)</span><br><span class="line"><span class="keyword">END</span> REPEAT</span><br><span class="line"><span class="comment">-- return the result table</span></span><br><span class="line">    <span class="keyword">RETURN</span> <span class="keyword">TABLE</span> c_prereq;</span><br><span class="line"><span class="keyword">END</span> </span><br></pre></td></tr></table></figure>

<h3 id="Recursion"><a href="#Recursion" class="headerlink" title="Recursion"></a>Recursion</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- define recursive query</span></span><br><span class="line"><span class="keyword">WITH</span> <span class="keyword">RECURSIVE</span> rec_prereq(course_id, prereq_id) <span class="keyword">AS</span> (<span class="keyword">SELECT</span> course_id, prereq_id</span><br><span class="line">                                                   <span class="keyword">FROM</span> prereq)</span><br><span class="line">                                                   <span class="keyword">UNION</span> </span><br><span class="line">                                                   (<span class="keyword">SELECT</span> rec_prereq, course_id, prereq.prereq_id</span><br><span class="line">                                                   <span class="keyword">FROM</span> prereq, rec_prereq</span><br><span class="line">                                                   <span class="keyword">WHERE</span> prereq.course_id <span class="operator">=</span> rec_prereq.prereq_id)</span><br><span class="line"><span class="comment">-- call recursive query</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> rec_prereq;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>上述的SQL中，首先通过 <code>基查询</code> 找到 <code>每门课程的先修课程</code>，然后 <code>递归查询</code> 在 <code>每次迭代过程</code> 中 <code>增加一层课程</code>，直到到达 <code>课程-先修课程的最大层次</code>。</p>
</blockquote>
<blockquote>
<p>通过 <code>FROM子句</code> 对 <code>递归视图 prc_prereq</code> 进行 <code>递归查询</code>。</p>
<p><code>WITH RECURSIVE</code> 用于声明 <code>递归视图</code>，它会使得 <code>递归</code> 在到达 <code>不动点</code> 时 <code>自动被终止</code></p>
</blockquote>
<blockquote>
<p><code>SQL标准</code> 要求 <code>递归过程</code> 返回的 <code>结果</code> 是 <code>单调递增的</code>，并且最终到达 <code>不动点 (Fixed Point)</code></p>
<blockquote>
<p>也就是说，每次 <code>递归过程</code> 返回的 <code>结果</code> 必须是 <code>之前的结果的超集</code></p>
</blockquote>
<blockquote>
<p>只要 <code>递归过程是递增的</code>，就可以使用 <code>迭代过程来定义递归过程</code>。</p>
</blockquote>
</blockquote>
<p>任何的 <code>递归查询 (Recursive Query)</code> &#x3D; <code>基查询 (Base Query)</code> UNION <code>递归查询 (Recursive Query)</code></p>
<h2 id="Advanced-Aggregate"><a href="#Advanced-Aggregate" class="headerlink" title="Advanced Aggregate"></a>Advanced Aggregate</h2><h3 id="Rank"><a href="#Rank" class="headerlink" title="Rank"></a>Rank</h3><h4 id="Sparse-Rank-amp-Dense-Rank"><a href="#Sparse-Rank-amp-Dense-Rank" class="headerlink" title="Sparse Rank &amp; Dense Rank"></a>Sparse Rank &amp; Dense Rank</h4><ul>
<li><code>rank()</code></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- SQL 1</span></span><br><span class="line"><span class="keyword">SELECT</span> ID, <span class="built_in">rank</span>() <span class="keyword">OVER</span> (<span class="keyword">ORDER</span> <span class="keyword">BY</span> (GPA) <span class="keyword">DESC</span>) <span class="keyword">AS</span> s_rank</span><br><span class="line"><span class="keyword">FROM</span> student_grades</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="string">&#x27;s_rank&#x27;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>单纯的 <code>rank</code> 并不会对 <code>结果关系中的元组</code> <code>按rank进行排序</code>。</p>
<p>故添加 <code>ORDER BY &#39;s_rank&#39;</code> 来对 <code>结果关系的元组</code> 进行 <code>排序</code></p>
</blockquote>
<blockquote>
<p>其他类型的 <code>排序函数</code>：<code>percent_rank()</code>，<code>cume_dist()</code>，<code>row_number()</code></p>
</blockquote>
<blockquote>
<p>关于 <code>空值</code> 的处理，可以设置策略：<code>NULL FIRST</code> 或 <code>NULL LAST</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ID, <span class="built_in">rank</span>() <span class="keyword">OVER</span> (<span class="keyword">ORDER</span> <span class="keyword">BY</span> (GPA) <span class="keyword">DESC</span> <span class="keyword">NULL</span> <span class="keyword">LAST</span>) <span class="keyword">AS</span> s_rank</span><br><span class="line"><span class="keyword">FROM</span> student_grades</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="string">&#x27;s_rank&#x27;</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>SQL 1 &#x3D; SQL 2</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- SQL 2</span></span><br><span class="line"><span class="keyword">SELECT</span> ID, (<span class="number">1</span> <span class="operator">+</span> (<span class="keyword">SELECT</span> <span class="built_in">count</span>(<span class="operator">*</span>)</span><br><span class="line">                <span class="keyword">FROM</span> student_grades B</span><br><span class="line">                <span class="keyword">WHERE</span> B.GPA <span class="operator">&gt;</span> A.GPA)) <span class="keyword">AS</span> s_rank</span><br><span class="line"><span class="keyword">FROM</span> student_grades A</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> s_rank</span><br></pre></td></tr></table></figure>

<ul>
<li><code>dense_rank()</code></li>
</ul>
<p><code>rank()</code> 产生的 <code>排名</code> 是 <code>间断的</code>：如果 <code>分数最高的人</code> 有2人，则 <code>这两个人的排名</code> 均为 <code>1</code>，但 <code>分数次高的人</code> 的 <code>排名</code> 则为 <code>3</code></p>
<p>相反的，如果使用 <code>dense_rank()</code>，则产生 <code>不间断</code> 的 <code>排名</code>：<code>分数最高的两人</code> 排名均为 <code>1</code>，但 <code>分数次高的人</code> 的 <code>排名</code> 则为 <code>2</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- SQL 3</span></span><br><span class="line"><span class="keyword">SELECT</span> ID, <span class="built_in">dense_rank</span>() <span class="keyword">OVER</span> (<span class="keyword">ORDER</span> <span class="keyword">BY</span> (GPA) <span class="keyword">DESC</span>) <span class="keyword">AS</span> s_rank</span><br><span class="line"><span class="keyword">FROM</span> student_grades</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="string">&#x27;s_rank&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="Partition-before-Rank"><a href="#Partition-before-Rank" class="headerlink" title="Partition before Rank"></a>Partition before Rank</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- SQL 4</span></span><br><span class="line"><span class="keyword">SELECT</span> ID, dept_name, <span class="built_in">rank</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept_name <span class="keyword">ORDER</span> <span class="keyword">BY</span> GPA <span class="keyword">DESC</span>) <span class="keyword">AS</span> DEPT_RANK</span><br><span class="line"><span class="keyword">FROM</span> dept_grades</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> dept_name, dept_rank;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>当存在 <code>GROUP BY</code> 时， <code>PARTION</code> 在 <code>GROUP BY</code> 之后执行。</p>
</blockquote>
<blockquote>
<p>可以认为，如果在 <code>聚集</code> 时没有 <code>显示地指定 PARTITION</code>，则认为 <code>将所有的集合</code> 分为 <code>唯一的一个分区</code></p>
</blockquote>
<h4 id="Grading"><a href="#Grading" class="headerlink" title="Grading"></a>Grading</h4><p><code>ntile(n)</code> 按 <code>给定顺序</code> 取得 <code>每个分区 (Partion) 中的元组</code>，然后将 <code>元组</code> 分成 <code>n个具有相同元组数目的桶</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ID, <span class="built_in">ntile</span>(<span class="number">4</span>) <span class="keyword">OVER</span> (<span class="keyword">ORDER</span> <span class="keyword">BY</span> (GPA <span class="keyword">DESC</span>)) <span class="keyword">AS</span> quartile</span><br><span class="line"><span class="keyword">FROM</span> student_grades;</span><br></pre></td></tr></table></figure>

<p>可用于构造 <code>百分比直方图</code></p>
<h3 id="Window-Query"><a href="#Window-Query" class="headerlink" title="Window Query"></a>Window Query</h3><p><code>窗口查询</code>：可用于对 <code>一定范围内的元组</code> 进行 <code>聚集</code></p>
<blockquote>
<p>不同于 <code>分区查询</code> 中的 <code>1个元组</code> 只对 <code>1个分区 (Partion)</code> 有贡献，<code>分窗查询</code> 中的 <code>窗口 (Window)</code> 是可以 <code>重叠的</code>。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">year</span>, <span class="built_in">avg</span>(num_credits) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">year</span> <span class="keyword">ROWS</span> <span class="number">3</span> PRECEDING) <span class="keyword">AS</span> avg_total_credits</span><br><span class="line"><span class="keyword">FROM</span> tot_credits;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>n.b. 如果 <code>某个年份的元组</code> 具有 <code>多个</code>，则 <code>为某个年份到底选择哪个元组</code> 将 <code>取决于具体实现</code>。</p>
</blockquote>
<blockquote>
<p><code>窗口</code> 的大小界定参数：</p>
<ul>
<li><code>ROWS n PRECEDING/FOLLOWING</code></li>
<li><code>ROWS UNBOUNDED PRECEDING/FOLLOWING</code></li>
<li><code>ROWS BETWEEN a PRECEEDING AND b FOLLOWING</code></li>
<li><code>RANGE BETWEEN a AND b</code></li>
</ul>
</blockquote>
<h2 id="OLAP"><a href="#OLAP" class="headerlink" title="OLAP"></a>OLAP</h2><h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><p><code>联机分析处理 (OLAP)</code> 是一个 <code>交互式系统</code>，允许 <code>分析人员</code> 查看 <code>多维数据</code> 的 <code>不同种类的汇总数据</code></p>
<hr>
<p>假如我们有 <code>模式</code> sales(item\_name, color, clothes\_size, quantity)</p>
<p>可以对 <code>关系中的某些属性</code> <code>分组 (Group)</code> 为 <code>度量属性</code> 和 <code>维属性</code>：</p>
<ul>
<li><code>度量属性 (Measure Attribute)</code>：对 <code>某个值</code> 进行 <code>度量</code>，并且可以对 <code>这个值</code> 进行 <code>聚集操作</code></li>
<li><code>维属性 (Dimension Attribute)</code>：<code>剩余的属性</code> 称为 <code>维属性</code></li>
</ul>
<p>能够 <code>模式化</code> 为 <code>度量属性</code> 和 <code>维属性</code> 的 <code>数据</code> 统称为 <code>多维数据 (Multi-Dimensional Data)</code></p>
<hr>
<p><code>数据立方体 (Data Cube)</code>：可以用于描述 <code>n维数据</code>。</p>
<blockquote>
<p><code>交叉表 (Cross-Tabulation / Pivot Table)</code>：可以用于描述 <code>二维属性</code>，是 <code>数据立方体</code> 的 <code>2维情形</code></p>
<p>某些 <code>交叉表</code> 可能还含有 <code>汇总行 (Total Row)</code> 和 <code>汇总列 (Total Column)</code></p>
</blockquote>
<p><code>单元 (Cell)</code>：<code>n维的数据单元</code> 可用 <code>n维向量</code> 进行 <code>定位</code>，每个 <code>单元</code> 存储 <code>1个值</code></p>
<blockquote>
<p>当 <code>某个维度</code> 的 <code>取值</code> 为 <code>all</code> 时，则表示 <code>对该维度的数据进行聚集</code>，即 <code>对该维度进行压缩</code>！</p>
<p>如 <code>clothes_size</code> 的 <code>all值</code> 是对 ：<code>small</code>，<code>medium</code> 和 <code>large</code> 进行 <code>聚集</code> 得到的。</p>
</blockquote>
<hr>
<ul>
<li>Select <code>attribute_list</code></li>
</ul>
<p><code>转轴 (Pivot)</code>：改变 <code>交叉表</code> 中 <code>维</code> 的操作</p>
<p><code>切片 (Slice) / 切块 (Dicing)</code>：<code>固定</code> <code>某个维度</code>，<code>观察</code> <code>其余的维度</code></p>
<blockquote>
<p>一般将 <code>切片</code> 用于 <code>固定1个维度</code>时，<code>切块</code> 用于 <code>固定多个维度</code> 时。</p>
</blockquote>
<ul>
<li>Change <code>observation granularity</code></li>
</ul>
<p><code>上卷 (RollUp)</code> ：即 <code>粒度变粗</code></p>
<p><code>下钻 (Drill Down)</code>：即 <code>粒度变细</code></p>
<blockquote>
<p><code>较粗粒度的数据</code> 可以由 <code>较细粒度的数据</code> 所产生，反之则不能。</p>
<p>即 <code>高维数据</code> 可以产生 <code>低维数据</code>，反之不能。</p>
</blockquote>
<p>一个 <code>属性</code> 可以有不同的 <code>粒度</code>，这些 <code>不同粒度</code> 组成 <code>层次结构</code>，如 <code>Datetime的层次结构</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">graph TD;</span><br><span class="line">date_time(DateTime) --&gt; hour_of_day(Hour of Day)</span><br><span class="line">date_time --&gt; date(Date)</span><br><span class="line">date --&gt; day_of_week(Day of Week)</span><br><span class="line">date --&gt; month(Month)</span><br><span class="line">month --&gt; quarter(Quarter)</span><br><span class="line">quarter --&gt; year(Year)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>当我们讨论 <code>属性的粒度</code> 时， 我们应当把 <code>粒度树</code> <code>倒过来看</code>，这样正好符合 <code>上卷</code> 和 <code>下钻</code>。</p>
<blockquote>
<p>计算机的 <code>树</code> 就是 <code>倒过来的自然界的树</code>，而 <code>粒度树</code> 是 <code>倒过来的树</code>，也就正好符合 <code>自然界的树</code>。</p>
</blockquote>
</blockquote>
<h3 id="OLAP-in-SQL"><a href="#OLAP-in-SQL" class="headerlink" title="OLAP in SQL"></a>OLAP in SQL</h3><p><code>模式</code> sales(item\_name, color, clothes\_size, quantity)</p>
<ul>
<li><code>pivot()</code></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> sales</span><br><span class="line">pivot(</span><br><span class="line"><span class="built_in">sum</span>(quantity)</span><br><span class="line">    <span class="keyword">FOR</span> color <span class="keyword">IN</span> (<span class="string">&#x27;dark&#x27;</span>, <span class="string">&#x27;pastel&#x27;</span>, <span class="string">&#x27;white&#x27;</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>pivot中的for</code> 的 <code>语义</code> 是：<code>解包</code> <code>指定属性的指定值</code> ，将 <code>这些值</code> 作为 <code>新属性</code> 插入。</p>
</blockquote>
<p>item_name</p>
<p>clothes_size</p>
<p>dark</p>
<p>pastel</p>
<p>white</p>
<p>skirt</p>
<p>small</p>
<p>2</p>
<p>11</p>
<p>2</p>
<p>…</p>
<p>…</p>
<p>…</p>
<p>…</p>
<p>…</p>
<ul>
<li><code>cube()</code></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> item_name, color, clothes_size, <span class="built_in">sum</span>(quantity)</span><br><span class="line"><span class="keyword">FROM</span> sales</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">cube</span>(item_name, color, clothes_size)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果需要处理 <code>all值</code>，则可以使用 <code>decode()</code> 和 <code>grouping()</code>。</p>
</blockquote>
<p>该查询返回的是一个 <code>关系</code> (item\_name, color, clothes\_size, quantity)</p>
<p>该关系表示1个 <code>3维的数据立方体</code></p>
<ul>
<li><code>rollup()</code></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> item_name, color, clothes_size, <span class="built_in">sum</span>(quantity)</span><br><span class="line"><span class="keyword">FROM</span> sales</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">rollup</span>(item_name, color, clothes_size)</span><br></pre></td></tr></table></figure>

<p>从 <code>返回的结果关系的模式</code> 来看，<code>rollup()</code> 和 <code>cube()</code> 返回的 <code>结果关系</code> 具有 <code>相同的模式</code>。</p>
<p>实际上，<code>rollup()</code> 生成的是：1个 <code>0维立方体</code>，1个 <code>1维立方体</code>，1个 <code>2维立方体</code>， 1个 <code>3维立方体</code></p>
<blockquote>
<p>无论是用 <code>cube()</code> 还是 <code>rollup()</code>，我们都无法 <code>精准控制分组的产生</code>，即无法 <code>精准指定分组具有哪些属性</code>。</p>
<p>但我们可以通过 <code>HAVING子句</code> 来去除 <code>GROUP子句</code> 产生的 <code>我们不想要的分组</code></p>
</blockquote>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/04/29/database-intermediate-sql/" rel="prev" title="Database - Intermediate SQL">
      <i class="fa fa-chevron-left"></i> Database - Intermediate SQL
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/04/30/database-relational-query-language/" rel="next" title="Database -  Relational Query Language">
      Database -  Relational Query Language <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Advanced-SQL"><span class="nav-number">1.</span> <span class="nav-text">Advanced SQL</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Access-DB-From-PL"><span class="nav-number">1.1.</span> <span class="nav-text">Access DB From PL</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Function-and-Procedure"><span class="nav-number">1.2.</span> <span class="nav-text">Function and Procedure</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Function"><span class="nav-number">1.2.1.</span> <span class="nav-text">Function</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Procedure"><span class="nav-number">1.2.2.</span> <span class="nav-text">Procedure</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Persistent-Storage-Module"><span class="nav-number">1.2.3.</span> <span class="nav-text">Persistent Storage Module</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#External-Language-Procedure"><span class="nav-number">1.2.4.</span> <span class="nav-text">External Language Procedure</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Trigger"><span class="nav-number">1.3.</span> <span class="nav-text">Trigger</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Recursive-Query"><span class="nav-number">1.4.</span> <span class="nav-text">Recursive Query</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Iteration"><span class="nav-number">1.4.1.</span> <span class="nav-text">Iteration</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Recursion"><span class="nav-number">1.4.2.</span> <span class="nav-text">Recursion</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Advanced-Aggregate"><span class="nav-number">1.5.</span> <span class="nav-text">Advanced Aggregate</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Rank"><span class="nav-number">1.5.1.</span> <span class="nav-text">Rank</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Sparse-Rank-amp-Dense-Rank"><span class="nav-number">1.5.1.1.</span> <span class="nav-text">Sparse Rank &amp; Dense Rank</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Partition-before-Rank"><span class="nav-number">1.5.1.2.</span> <span class="nav-text">Partition before Rank</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Grading"><span class="nav-number">1.5.1.3.</span> <span class="nav-text">Grading</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Window-Query"><span class="nav-number">1.5.2.</span> <span class="nav-text">Window Query</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#OLAP"><span class="nav-number">1.6.</span> <span class="nav-text">OLAP</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Introduction"><span class="nav-number">1.6.1.</span> <span class="nav-text">Introduction</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#OLAP-in-SQL"><span class="nav-number">1.6.2.</span> <span class="nav-text">OLAP in SQL</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">John Doe</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">103</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
