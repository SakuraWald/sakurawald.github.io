<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"sakurawald.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Intermediate SQLJoin ExpressionJoin Conditionnatural使用 natural 作为 连接条件 的 连接 (Join) 称为 自然连接 (Natural Join)。  我们前面讨论过，可以将 natura展开为 using attribute_list 展开为 on &lt;predicate&gt;  using attribute_list指定对">
<meta property="og:type" content="article">
<meta property="og:title" content="Database - Intermediate SQL">
<meta property="og:url" content="https://sakurawald.github.io/2022/04/29/database-intermediate-sql/index.html">
<meta property="og:site_name" content="SakuraWald">
<meta property="og:description" content="Intermediate SQLJoin ExpressionJoin Conditionnatural使用 natural 作为 连接条件 的 连接 (Join) 称为 自然连接 (Natural Join)。  我们前面讨论过，可以将 natura展开为 using attribute_list 展开为 on &lt;predicate&gt;  using attribute_list指定对">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-04-29T16:39:10.000Z">
<meta property="article:modified_time" content="2023-01-01T23:38:44.219Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://sakurawald.github.io/2022/04/29/database-intermediate-sql/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>Database - Intermediate SQL | SakuraWald</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">SakuraWald</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://sakurawald.github.io/2022/04/29/database-intermediate-sql/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SakuraWald">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Database - Intermediate SQL
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-04-29 16:39:10" itemprop="dateCreated datePublished" datetime="2022-04-29T16:39:10+00:00">2022-04-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-01-01 23:38:44" itemprop="dateModified" datetime="2023-01-01T23:38:44+00:00">2023-01-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/uncategorized/" itemprop="url" rel="index"><span itemprop="name">uncategorized</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Intermediate-SQL"><a href="#Intermediate-SQL" class="headerlink" title="Intermediate SQL"></a>Intermediate SQL</h1><h2 id="Join-Expression"><a href="#Join-Expression" class="headerlink" title="Join Expression"></a>Join Expression</h2><h3 id="Join-Condition"><a href="#Join-Condition" class="headerlink" title="Join Condition"></a>Join Condition</h3><h4 id="natural"><a href="#natural" class="headerlink" title="natural"></a>natural</h4><p>使用 <code>natural</code> 作为 <code>连接条件</code> 的 <code>连接 (Join)</code> 称为 <code>自然连接 (Natural Join)</code>。</p>
<blockquote>
<p>我们前面讨论过，可以将 <code>natura</code>展开为 <code>using attribute_list</code> 展开为 <code>on &lt;predicate&gt;</code></p>
</blockquote>
<h4 id="using-attribute-list"><a href="#using-attribute-list" class="headerlink" title="using attribute_list"></a>using attribute_list</h4><p>指定对 <code>参与连接的关系</code> 进行 <code>连接</code> 时所使用的 <code>属性列表 (Attribute List)</code></p>
<h4 id="on"><a href="#on" class="headerlink" title="on "></a>on <Predicate></h4><p><code>on条件</code> 用于设置 <code>参与连接的关系</code> 的 <code>元组匹配</code> 的 <code>通用谓词</code></p>
<blockquote>
<p>从 <code>功能范围</code> 来讲：<code>on &lt;Predicate&gt;</code> &gt; <code>using attribute_list</code> &gt; <code>natural</code></p>
</blockquote>
<hr>
<p>我们考虑下面两个连接。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- SQL 1</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> student <span class="keyword">JOIN</span> takes <span class="keyword">ON</span> student.ID <span class="operator">=</span> takes.ID</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- SQL 2</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> student <span class="keyword">NATURAL</span> <span class="keyword">JOIN</span> takes</span><br></pre></td></tr></table></figure>

<p><code>SQL1</code> \ne <code>SQL 2</code> ，但它们的 <code>结果关系</code> 高度 <code>相似</code>，<code>唯一的区别</code> 是：<code>SQL 1</code> 的 <code>结果关系</code> 中， <code>ID属性</code> 出现 <code>2次</code>，分别为 <code>student.ID</code> 和 <code>takes.ID</code></p>
<blockquote>
<p>注意 <code>on &lt;predicate&gt;</code> 的 <code>语义</code>：<code>&lt;predicate&gt;</code> <code>过滤出</code> <code>能参与连接的元组</code>。</p>
<p>注意 <code>join</code> 的语义：最基本的 <code>连接 (Join)</code> 操作就是 <code>简单地</code> <code>将两个元组</code> 进行 <code>拼接</code>。</p>
<blockquote>
<p><code>自动去除相同的属性名</code> 是 <code>natural join</code> 的 <code>特性</code>，<code>join</code> 并不会这么做！</p>
</blockquote>
</blockquote>
<p>然而，对于 <code>SQL 2</code>来说，由于 <code>student关系</code> 和 <code>takes关系</code> 的 <code>共有属性</code> 仅有 <code>ID</code>，所以 <code>连接条件</code> 也是 <code>student.ID = takes.ID</code>。</p>
<p>但 <code>Natural Join</code> 会 <code>自动地去除属性名相同的列</code>，所以 <code>ID属性</code> 仅在 <code>SQL 2的结果关系</code> 中 <code>出现1次</code></p>
<p>更确切地</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- SQL 3 equals SQL 1</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> student, takes</span><br><span class="line"><span class="keyword">WHERE</span> student.ID <span class="operator">=</span> takes.ID</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- SQL 4 equals SQL 2</span></span><br><span class="line"><span class="keyword">SELECT</span> student.ID <span class="keyword">as</span> ID, name, dept_name, tot_cred, course_id, sec_id, semester, <span class="keyword">year</span>, grade</span><br><span class="line"><span class="keyword">FROM</span> student <span class="keyword">JOIN</span> takes <span class="keyword">ON</span> student.ID <span class="operator">=</span> takes.ID</span><br></pre></td></tr></table></figure>

<h3 id="Join-Type"><a href="#Join-Type" class="headerlink" title="Join Type"></a>Join Type</h3><h4 id="Inner-Join"><a href="#Inner-Join" class="headerlink" title="Inner Join"></a>Inner Join</h4><p><code>内连接 (Inner Join)</code> 是 <code>默认的连接类型</code>。</p>
<blockquote>
<p>当我们写 <code>JOIN</code> 时，实际上是省略了 <code>INNER</code> 的 <code>INNER JOIN</code>。</p>
<p>同理，<code>NATURAL JOIN</code> &#x3D; <code>NATURAL INNER JOIN</code></p>
</blockquote>
<h4 id="Outer-Join"><a href="#Outer-Join" class="headerlink" title="Outer Join"></a>Outer Join</h4><p>考虑该语句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> student <span class="keyword">NATURAL</span> <span class="keyword">JOIN</span> takes;</span><br></pre></td></tr></table></figure>

<p>该 <code>语句</code> 的 <code>期望</code> 是： <code>查询出所有学生的选课信息</code></p>
<p>但是，如果 <code>某些学生没有选任何课</code>，那么在 <code>结果关系</code> 中，我们将无法看到 <code>这些学生</code>。</p>
<p>如果我们 <code>希望</code> 在 <code>结果关系</code> 中，<code>仍然显示出</code> <code>没有选任何课的学生</code> 的信息，并且 <code>将它们的选课信息</code> 显示为 <code>null</code>。</p>
<p>则可以使用 <code>外连接</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> student <span class="keyword">NATURAL</span> <span class="keyword">LEFT</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> takes;</span><br></pre></td></tr></table></figure>

<hr>
<p><code>外连接 (Outer Join)</code>：在 <code>内连接</code> 的基础上，通过在 <code>结果关系</code> 中 <code>创建包含空值的元组</code> 来 <code>保留</code> <code>哪些本来在内连接中丢失的元组</code></p>
<blockquote>
<p>换句话说：<code>外连接</code> 会将 <code>那些有参与连接</code> 但 <code>不满足连接条件的元组</code> 的 <code>那些本该被内连接丢弃的元组</code> 重新 <code>捡回来</code>，然后 <code>填充空值</code>。</p>
<p>注意一个细节，我们说 <code>参与连接的元组</code> 指的是按照所属的 <code>连接表达式</code> 作为 <code>边界</code> 来划分的。<code>另一个连接表达式</code> 和 <code>WHERE子句</code> 显然都属于 <code>边界之外</code>。</p>
<p><code>外连接</code> 只会 <code>捡回那些参与了连接但不满足连接条件的元组，并为它们填充空值</code>。如果 <code>某些元组根本没有参与这个外连接</code>，那么 <code>显然这些元组不应该被这个外连接所捡回并填充空值</code>。</p>
</blockquote>
<p><code>外连接</code> 的 3种 <code>类型</code>：</p>
<ul>
<li><code>左外连接 (Left Outer Join)</code>：只 <code>保留</code> 出现在 <code>左外连接运算符</code> <code>左边的关系中的元组</code></li>
<li><code>右外连接 (Right Outer Join)</code>：只 <code>保留</code> 出现在 <code>右外连接运算符</code> <code>右边的关系中的元组</code></li>
<li><code>全外连接 (Full Outer Join)</code>：<code>保留</code> <code>两个关系中的元组</code></li>
</ul>
<blockquote>
<p>相比来说，<code>内连接</code> 不 <code>保留</code> <code>两侧的关系中的任何关系中的元组</code></p>
</blockquote>
<blockquote>
<p><code>外连接的计算方法</code>：可以先计算 <code>相应的内连接</code>，然后向 <code>内连接的结果关系</code> 中 <code>加入</code> <code>应当被保留的元组</code></p>
</blockquote>
<hr>
<p>考虑该查询</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- SQL 1</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> student <span class="keyword">LEFT</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> takes <span class="keyword">ON</span> student.ID <span class="operator">=</span> takes.ID;</span><br></pre></td></tr></table></figure>

<p><code>SQL 1</code> \ne <code>SQL 2</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- SQL 2</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> student <span class="keyword">LEFT</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> takes <span class="keyword">ON</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">WHERE</span> student.ID <span class="operator">=</span> takes.ID;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>SQL 1</code>：<code>结果关系</code> 类似于 <code>student LEFT NATURAL OUTER JOIN takes</code> ，只不过 <code>ID属性将出现2次</code>。</p>
</li>
<li><p><code>SQL 2</code>：由于指定 <code>ON true</code> 使得 <code>参与连接的关系中的所有元组</code> 都 <code>满足连接条件</code>，所以 <code>外连接</code> 不会 <code>加入被内连接丢弃的元组并为它们填充空值</code></p>
<blockquote>
<p>也就是说 <code>由于没有元组因不满足连接条件而被内连接所丢弃</code>，所以后续 <code>外连接</code> 也不会 <code>加入这些本来被内连接丢弃的元组并为它们填充空值</code></p>
</blockquote>
<p>实际上，<code>a LEFT OUTER JOIN b ON true</code> 相当于 <code>产生两个关系的笛卡尔积</code>。</p>
<blockquote>
<p>不要将 <code>a LEFT OUTER JOIN b ON true</code> 和 <code>NATURAL LEFT OUTER JOIN</code> 弄 <code>混淆</code>，<code>NATURAL</code> 只不过是 <code>连接条件</code> 中的一种而已。</p>
</blockquote>
</li>
</ul>
<h2 id="View"><a href="#View" class="headerlink" title="View"></a>View</h2><h3 id="Definition"><a href="#Definition" class="headerlink" title="Definition"></a>Definition</h3><p><code>视图 (View)</code>：是一种 <code>通过查询来定义的</code> <code>虚关系 (Virtual Relation)</code>。它在 <code>概念层</code> 包含 <code>查询的结果</code>，但 <code>序关系</code>并不 <code>预先计算并存储</code>，而是在 <code>查询时临时进行计算</code> 而得到。</p>
<blockquote>
<p>该 <code>定义</code> 暂时不考虑 <code>物化视图 (Materialized View)</code></p>
</blockquote>
<h3 id="Create-a-view"><a href="#Create-a-view" class="headerlink" title="Create a view"></a>Create a view</h3><p>所定义的 <code>视图</code> 的 <code>模式</code> 可以从 <code>查询语句</code> 中自动地被 <code>推导</code> 出来</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> faculty <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> ID, name, dept_name</span><br><span class="line"><span class="keyword">FROM</span> instructor;</span><br></pre></td></tr></table></figure>

<p>当然，也可以指定 <code>视图的属性名</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> departments_total_salary(dept_name, total_salary) <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> dept_name, <span class="built_in">sum</span>(salary)</span><br><span class="line"><span class="keyword">FROM</span> instructor</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> dept_name;</span><br></pre></td></tr></table></figure>

<h3 id="Materialized-View"><a href="#Materialized-View" class="headerlink" title="Materialized View"></a>Materialized View</h3><p><code>物化视图 (Materialized View)</code>：和 <code>非物化视图</code> 的区别在于，<code>物化视图</code> 会 <code>存储查询的结果关系</code>，并 <code>保证</code> 当 <code>实际关系</code> 更新时，<code>物化视图</code> 也应当有 <code>相应的维护策略</code>。这个过程称为 <code>物化视图的维护 (Materialized View Maintenance)</code></p>
<p><code>物化视图</code> 的 <code>维护策略 (Maintenance Strategy)</code>：</p>
<ul>
<li>立即更新</li>
<li>延迟更新</li>
</ul>
<hr>
<p>我们称 <code>物化视图</code>是 <code>可更新的 (Updatable)</code> ：可以对 <code>该物化视图</code> 进行 <code>修改性操作</code>，且 <code>这些操作可以正确地反映到实关系</code>。</p>
<blockquote>
<p>大部分的 <code>物化视图</code> 都是 <code>不可更新的</code>，仅能用于 <code>查询</code>。</p>
<p>这是因为 <code>单纯从视图定义的查询语句</code> 很难 <code>翻译出等价的且合法的更新语句</code>。</p>
</blockquote>
<p>考虑该 <code>视图定义</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> history_instructors <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> instructor</span><br><span class="line"><span class="keyword">WHERE</span> dept_name <span class="operator">=</span> <span class="string">&#x27;History&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>如果我们 <code>视图</code> 执行 <code>该语句</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> history_instructors</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="string">&#x27;25566&#x27;</span>, <span class="string">&#x27;Brown&#x27;</span>, <span class="string">&#x27;Biology&#x27;</span>, <span class="number">100000</span>)</span><br></pre></td></tr></table></figure>

<p>则也 <code>可能</code> 存在 <code>错误</code>，原因在于：<code>欲插入视图中的元组</code> 无法在 <code>视图中被查询出来</code>。即 <code>新值</code> 不满足 <code>视图的WHERE子句</code></p>
<blockquote>
<p><code>SQL</code> 默认允许这种操作。如果希望禁止这种操作，可以在 <code>CREATE VIEW</code> 时添加 <code>WITH CHECK OPTION</code></p>
</blockquote>
<h2 id="Transaction"><a href="#Transaction" class="headerlink" title="Transaction"></a>Transaction</h2><p><code>事务 (Transaction)</code>：由 <code>SQL语句的序列</code> 组成，<code>事务</code> 拥有 <code>ACID性</code></p>
<blockquote>
<p>按照 <code>SQL标准</code>，<code>任何一条单独的SQL语句</code> 都 <code>隐含地</code> <code>开始于一个新事务</code>。</p>
</blockquote>
<blockquote>
<p>从编程角度说，如果为了保证 <code>多条SQL语句的原子性</code>，则需要对 <code>SQL连接驱动</code> 做出相应的设置。</p>
<p>如使用 <code>JDBC</code> 时，首先关闭 <code>单条SQL语句的自动提交</code>。</p>
</blockquote>
<h2 id="Integrity-Constraint"><a href="#Integrity-Constraint" class="headerlink" title="Integrity Constraint"></a>Integrity Constraint</h2><p><code>完整性约束 (Integrity Constraint)</code>：保证 <code>授权用户</code> 对 <code>数据库的修改性操作</code> 不会 <code>破坏</code> <code>数据库</code> 的 <code>数据一致性</code></p>
<p>常见的 <code>完整性约束</code>：</p>
<h3 id="Integrity-Constraint-for-Single-Relation"><a href="#Integrity-Constraint-for-Single-Relation" class="headerlink" title="Integrity Constraint for Single-Relation"></a>Integrity Constraint for Single-Relation</h3><ul>
<li><code>not null约束</code></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">name <span class="type">varchar</span>(<span class="number">30</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">bugder <span class="type">numeric</span>(<span class="number">12</span>,<span class="number">2</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br></pre></td></tr></table></figure>

<p>由于 <code>空值</code> 是 <code>所有的域的成员</code>，所以对于 <code>SQL</code>来说，<code>空值</code> 可以是 <code>任何属性</code> 的 <code>合法值</code>。</p>
<p>如果希望 <code>禁止某个属性的值为空值</code>，则可以设置 <code>not null</code></p>
<ul>
<li><code>unique约束</code></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UNIQUE</span>(attribute_list)</span><br></pre></td></tr></table></figure>

<p><code>unique约束</code> 用于指定 <code>某个属性列表</code> 为 <code>候选码</code>：即在 <code>关系</code> 中，没有 <code>任何两个元组</code> 可以在 <code>作为候选码的属性</code> 上的 <code>取值</code> <code>都相同</code>。</p>
<blockquote>
<p>n.b. <code>候选码属性</code> 可以被设置为 <code>null</code> （除非已经被声明 <code>not null</code>），由于 <code>unique约束</code> 是基于 <code>元组的相等性测试</code> 的，它和 <code>unique结构</code> 对待 <code>null</code> 的方式相同。</p>
</blockquote>
<ul>
<li><code>check子句</code></li>
</ul>
<p>可以为 <code>关系</code> 定义 <code>check(Predicate)</code> ，使得 <code>关系中的所有元组</code> 都必须 <code>满足该谓词</code>。</p>
<blockquote>
<p>可以使用 <code>check</code> 来 <code>代替</code> <code>unique</code>，<code>not null</code></p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> section</span><br><span class="line">(course_id <span class="type">varchar</span>(<span class="number">8</span>),</span><br><span class="line"> sec_id <span class="type">varchar</span>(<span class="number">8</span>),</span><br><span class="line"> semester <span class="type">varchar</span>(<span class="number">6</span>),</span><br><span class="line"> <span class="keyword">year</span> <span class="type">numeric</span>(<span class="number">4</span>,<span class="number">0</span>),</span><br><span class="line"> building <span class="type">varchar</span>(<span class="number">15</span>),</span><br><span class="line"> room_number <span class="type">varchar</span>(<span class="number">7</span>),</span><br><span class="line"> time_slot_id <span class="type">varchar</span>(<span class="number">4</span>),</span><br><span class="line"> <span class="keyword">PRIMARY</span> KEY (course_id, sec_id, semester, <span class="keyword">year</span>),</span><br><span class="line"> <span class="keyword">CHECK</span>(semester <span class="keyword">IN</span> (<span class="string">&#x27;Fall&#x27;</span>, <span class="string">&#x27;Winter&#x27;</span>, <span class="string">&#x27;Spring&#x27;</span>, <span class="string">&#x27;Summer&#x27;</span>))</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="Referential-Integrity"><a href="#Referential-Integrity" class="headerlink" title="Referential Integrity"></a>Referential Integrity</h3><h4 id="Definition-1"><a href="#Definition-1" class="headerlink" title="Definition"></a>Definition</h4><p><code>参照完整性 (Referential Integrity)</code>：在 <code>某个关系的给定属性集上的取值</code> 也 <code>必须出现在</code> <code>另一个关系的特定属性集的取值</code> 。</p>
<blockquote>
<p>若 <code>关系</code> r_1 和 <code>关系</code> r_2 的 <code>属性集</code> 分别为 R_1 和 R_2，<code>主码</code> 分别为 K_1 和 K_2。</p>
<p>若对于 R_2 中的 <code>任何元组</code> t_2 ，都存在 t_1.K_1 &#x3D; t_2.\b\alpha</p>
<p>则我们称：R_2的子集 \alpha 为 <code>参照关系</code> r_1 中 K_1 的 <code>外码 (Foreign Key)</code></p>
<blockquote>
<p>即：我们要求 r_2 中 \alpha 上的 <code>取值集合</code> 必须是 r_1 中 K_1 上的 <code>取值集合</code> 的 <code>子集</code>。</p>
<p>从这个意义上，<code>参照完整性</code> 又被称为 <code>子集依赖 (Subset Dependency)</code></p>
</blockquote>
<blockquote>
<p>不同于 <code>外码约束</code>，<code>参照完整性</code> 并不要求 K_1 是 r_1 的 <code>主码</code></p>
</blockquote>
</blockquote>
<hr>
<h4 id="A-simple-demo"><a href="#A-simple-demo" class="headerlink" title="A simple demo"></a>A simple demo</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> section</span><br><span class="line">(...</span><br><span class="line"> <span class="keyword">FOREIGN</span> KEY(dept_name) <span class="keyword">REFERENCES</span> department</span><br><span class="line"> <span class="keyword">ON</span> <span class="keyword">DELETE</span> CASCADE</span><br><span class="line"> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> CASCADE</span><br><span class="line"> ...</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>使用 <code>REFERENCE子句</code> 时，要求 <code>属性列表</code> 必须是 <code>被参照关系的候选码</code>。</p>
<blockquote>
<p>可以通过 <code>PRIMARY KEY</code> 和 <code>UNIQUE</code> 来使得 <code>属性</code> 成为 <code>候选码 (Candidate Key)</code></p>
</blockquote>
</blockquote>
<p>可以为 <code>参照完整性约束</code> 中的 <code>外码</code> 设置 <code>删除策略</code> 和 <code>更新策略</code></p>
<p>常见的几种策略有：</p>
<ul>
<li><code>CASCADE</code></li>
<li><code>SET NULL</code></li>
<li><code>SET DEFAULT</code></li>
</ul>
<hr>
<p>n.b. 对于 <code>元组的外码属性的相等性测试</code> 有 <code>特殊规则</code> ：如果 <code>某个元组的某个外码属性</code> 为 <code>null</code>，则会 <code>被视为满足约束</code>。</p>
<h3 id="Defer-Integrity-Constraint"><a href="#Defer-Integrity-Constraint" class="headerlink" title="Defer Integrity Constraint"></a>Defer Integrity Constraint</h3><p>对于 <code>多步骤的事务</code> 来说，可能在 <code>事务的中间过程</code> <code>暂时性地违反完整性约束</code> ，但在 <code>事务之后的步骤</code> 又 <code>重新符合完整性约束</code>。</p>
<p>此时，可以使用 <code>initially deferred子句</code> 来将 <code>完整性约束检测</code> 从 <code>事务中间步骤</code> <code>推迟到</code> <code>事务结束时</code> 再进行 <code>检测</code></p>
<h3 id="Complex-Check-Constraint"><a href="#Complex-Check-Constraint" class="headerlink" title="Complex Check Constraint"></a>Complex Check Constraint</h3><p>根据 <code>SQL标准</code> 来说，<code>check</code> 中允许定义 <code>任何谓词</code>。</p>
<p>如果 <code>check的谓词</code> 中包含 <code>子查询</code>，则该 <code>check</code> 是 <code>复杂的</code>。</p>
<p>考虑该例子</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CHECK</span>(time_slot_id <span class="keyword">IN</span> (<span class="keyword">SELECT</span> time_slot_id <span class="keyword">FROM</span> time_slot))</span><br></pre></td></tr></table></figure>

<p>为了维护 <code>check约束</code>，并非仅仅是 <code>简单地在插入或更新元组时</code> 进行 <code>检查</code>，在 <code>子查询所涉及的关系</code> 发生 <code>变化</code> 时，也需要进行 <code>检查</code>。</p>
<h2 id="Assertion"><a href="#Assertion" class="headerlink" title="Assertion"></a>Assertion</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> ASSERTION credits_earned_constraint <span class="keyword">CHECK</span>(</span><br><span class="line"><span class="keyword">NOT</span> <span class="keyword">EXISTS</span>(<span class="keyword">SELECT</span> ID</span><br><span class="line">           <span class="keyword">FROM</span> student</span><br><span class="line">           <span class="keyword">WHERE</span> tot_cred <span class="operator">&lt;&gt;</span> (<span class="keyword">SELECT</span> <span class="built_in">sum</span>(credits)</span><br><span class="line">                             <span class="keyword">FROM</span> takes <span class="keyword">NATURAL</span> <span class="keyword">JOIN</span> course</span><br><span class="line">                              <span class="keyword">WHERE</span> student.ID <span class="operator">=</span> takes.ID</span><br><span class="line">                              <span class="keyword">AND</span> grade <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">                              <span class="keyword">AND</span> grade <span class="operator">&lt;&gt;</span> <span class="string">&#x27;F&#x27;</span></span><br><span class="line">                              )</span><br><span class="line">)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><code>断言 (Assertion)</code>：<code>断言</code> 是 <code>谓词</code> 的一种形式，用于描述我们希望 <code>数据库</code> <code>总能</code> <code>满足的条件</code>。</p>
<blockquote>
<p><code>域约束</code>，<code>参照完整性约束</code> 均属于 <code>断言</code></p>
</blockquote>
<blockquote>
<p>目前大部分的 <code>数据库</code> 对 <code>断言 (Assertion)</code> 的支持不完善。</p>
<p><code>维护</code> 一个 <code>断言</code> 的代价是非常大的。如果可能，可以使用 <code>触发器 (Trigger)</code> 来代替 <code>断言</code> 。</p>
</blockquote>
<h2 id="Data-Type-and-Pattern"><a href="#Data-Type-and-Pattern" class="headerlink" title="Data Type and Pattern"></a>Data Type and Pattern</h2><h3 id="Date-and-Time"><a href="#Date-and-Time" class="headerlink" title="Date and Time"></a>Date and Time</h3><p>Type</p>
<p>Node</p>
<p>date</p>
<p><code>日历日期</code>，如 <code>1990-06-21</code></p>
<p>time</p>
<p><code>一天中的时间</code>，如 <code>8:42:26</code></p>
<p>timestamp</p>
<p><code>date和time的组合</code>，如 <code>1990-06-21 8:42:26</code></p>
<h3 id="Default-Value"><a href="#Default-Value" class="headerlink" title="Default Value"></a>Default Value</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> student</span><br><span class="line">(ID <span class="type">varchar</span>(<span class="number">5</span>),</span><br><span class="line"> name <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line"> dept_name <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line"> tot_cred <span class="type">numeric</span>(<span class="number">3</span>, <span class="number">0</span>) <span class="keyword">DEFAULT</span> <span class="number">0</span></span><br><span class="line"> <span class="keyword">PRIMARY</span> KEY(ID)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="Index"><a href="#Index" class="headerlink" title="Index"></a>Index</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> INDEX studentID_index <span class="keyword">ON</span> student(ID)</span><br></pre></td></tr></table></figure>

<h3 id="Big-Object-Type"><a href="#Big-Object-Type" class="headerlink" title="Big Object Type"></a>Big Object Type</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> demo</span><br><span class="line">(</span><br><span class="line">    book_review <span class="type">clob</span>(<span class="number">10</span>KB)</span><br><span class="line">    image <span class="type">blob</span>(<span class="number">10</span>MB)</span><br><span class="line">    movie <span class="type">blob</span>(<span class="number">2</span>GB)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>当 <code>查询</code> <code>大对象</code> 时，<code>数据库</code> 并非直接 <code>返回整个大对象</code>。而是 <code>返回用于检索该大对象的定位器</code>。</p>
<p>这类似于 <code>迭代器</code> 或 <code>文件指针</code>，可以 <code>按小片段</code> <code>逐步地访问</code> <code>整个大对象</code></p>
</blockquote>
<h3 id="User-Defined-Type"><a href="#User-Defined-Type" class="headerlink" title="User Defined Type"></a>User Defined Type</h3><ul>
<li><code>独特类型 (Distinct Type)</code></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> TYPE Dollars <span class="keyword">AS</span> <span class="type">numeric</span>(<span class="number">12</span>, <span class="number">2</span>) <span class="keyword">FINAL</span>;</span><br><span class="line"><span class="keyword">CREATE</span> TYPE Pounds <span class="keyword">AS</span> <span class="type">numeric</span>(<span class="number">12</span>, <span class="number">2</span>) <span class="keyword">FINAL</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> department</span><br><span class="line">(dept_name <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line"> building <span class="type">varchar</span>(<span class="number">15</span>),</span><br><span class="line"> budget Dollars</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>final关键字</code> 是没有任何意义的。属于 <code>SQL标准</code> 的 <code>历史遗留问题</code></p>
</blockquote>
<p>这里的关键点是，<code>Dollars</code> 是 <code>独特类型</code>，不能将 <code>Pounds</code> 类型赋值给 <code>Dollars</code> 类型</p>
<blockquote>
<p>尽管 <code>Dollars</code> 和 <code>Pounds</code> 基于 <code>相同的基本数据类型</code> 而定义的。</p>
</blockquote>
<p>甚至，我们也无法将 <code>Integer</code> 赋值给 <code>Dollars</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- This is wrong</span></span><br><span class="line">department.budget <span class="operator">+</span> <span class="number">20</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- This is right</span></span><br><span class="line"><span class="built_in">cast</span>(department.budget <span class="keyword">to</span> <span class="type">numeric</span>(<span class="number">12</span>,<span class="number">2</span>)) <span class="operator">+</span> <span class="number">20</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>之前我们讨论过 <code>域 (Domain)</code>，它和 <code>独特类型</code> 的区别在于：</p>
<ul>
<li><code>域</code> 上可以声明 <code>约束</code> 和 定义 <code>默认值</code></li>
<li><code>域</code> 并不是 <code>强类型的</code>，<code>基本类型相容的域</code> 可以 <code>相互赋值</code>。</li>
</ul>
</blockquote>
<ul>
<li><code>结构化数据类型 (Structured Data Type)</code></li>
</ul>
<p>可以创建 <code>具有嵌套记录结构</code>，<code>数组</code>，<code>多重集</code> 的 <code>复杂数据类型</code></p>
<h2 id="Create-Table-Extension"><a href="#Create-Table-Extension" class="headerlink" title="Create Table Extension"></a>Create Table Extension</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> temp_instructor <span class="keyword">LIKE</span> instructor</span><br></pre></td></tr></table></figure>

<h2 id="Schema-Catalog-and-Environment"><a href="#Schema-Catalog-and-Environment" class="headerlink" title="Schema, Catalog and Environment"></a>Schema, Catalog and Environment</h2><p><code>目录 (Catalog)</code> 和<code>模式 (Schema)</code>用于为 <code>关系</code> 提供 <code>命名空间</code>，它们都是用于 <code>限定</code> <code>关系</code> 的 <code>限定名</code>。</p>
<blockquote>
<p>部分 <code>数据库实现</code> 使用 <code>数据库</code> 术语 来代替 <code>目录</code>。</p>
</blockquote>
<p>如下例子</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">catelog5.univ_schema.course</span><br></pre></td></tr></table></figure>

<blockquote>
<p>每个 <code>用户 (User)</code> 都有自己的 <code>默认目录 (Default Catalog)</code> 和 <code>默认模式 (Default Schema)</code>。</p>
<p>当 <code>用户</code> 连接到 <code>数据库</code> 时，会为 <code>该连接自动地配置为</code> <code>默认目录</code> 和 <code>默认模式</code>。</p>
<blockquote>
<p>这类似于 <code>OS</code> 中为 <code>登陆OS的用户</code> 自动地切换 <code>当前目录</code> 为 <code>用户的主目录 (Home Directory)</code></p>
</blockquote>
<p>当 <code>创建</code> <code>新用户</code> 时，会 <code>自动地</code> 创建 <code>与该用户名同名的模式</code></p>
</blockquote>
<blockquote>
<p>在前面的例子中，我们都没有指定 <code>catelog</code> 和 <code>schema</code>。</p>
<p>这是因为我们一直在使用 <code>用户的默认目录</code> 和 <code>用户的默认模式</code>。即直接用</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">course</span><br></pre></td></tr></table></figure>

<p>来 <code>定位</code> <code>course关系</code></p>
</blockquote>
<h2 id="Authorization"><a href="#Authorization" class="headerlink" title="Authorization"></a>Authorization</h2><p><code>授权 (Authorization)</code>：将某种 <code>权限 (Privilege/Permission)</code> 授予 <code>某个用户 (User)</code> 或 <code>某个角色 (Role)</code></p>
<h3 id="Grant-and-Revoke"><a href="#Grant-and-Revoke" class="headerlink" title="Grant and Revoke"></a>Grant and Revoke</h3><p><code>授予权限</code> 和 <code>撤销权限</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span> <span class="keyword">ON</span> department <span class="keyword">TO</span> Amit, Satoshi;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">REVOKE</span> <span class="keyword">SELECT</span> <span class="keyword">ON</span> department <span class="keyword">FROM</span> AMit, Satoshi;</span><br></pre></td></tr></table></figure>

<hr>
<p>授权的 <code>最细粒度</code> 为 <code>关系的属性</code> ：<code>SQL标准</code> 允许对 <code>关系的某个属性</code> 授权，但不允许对 <code>关系的某个特定元组</code> 进行授权。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GRANT</span> <span class="keyword">UPDATE</span>(budget) <span class="keyword">ON</span> department <span class="keyword">TO</span> Amit, Satoshi;</span><br></pre></td></tr></table></figure>

<h3 id="Role"><a href="#Role" class="headerlink" title="Role"></a>Role</h3><p><code>角色 (Role)</code>：即 <code>权限(Permission)的集合</code>。可以将 <code>角色</code> 授予 <code>用户</code>，使得 <code>用户</code> 获得 <code>这些权限</code></p>
<p>使用 <code>角色</code> 的两点好处：</p>
<ul>
<li>可以一次性地授予 <code>权限集</code> 给 <code>角色</code>，然后再把 <code>角色</code> 授予给 <code>用户</code>，避免对 <code>每个用户</code> 都繁琐的授予 <code>权限集</code></li>
<li>即可以 <code>标识</code> <code>用户的身份</code>，同时可以避免 <code>所有相同身份的人使用同个用户</code> 导致 <code>安全隐患</code></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> ROLE instructor;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span> <span class="keyword">ON</span> takes <span class="keyword">TO</span> instructor</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GRANT</span> instructor <span class="keyword">TO</span> Amit</span><br></pre></td></tr></table></figure>

<h3 id="View-Authorization"><a href="#View-Authorization" class="headerlink" title="View Authorization"></a>View Authorization</h3><p>对于 <code>仅有查看Geology系权限的工作人员</code>，尽管 <code>它没有权限查看其他系的元组</code>，下列 <code>语句</code> 仍然是 <code>合法的</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> geo_instructor <span class="keyword">AS</span></span><br><span class="line">(<span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"> <span class="keyword">FROM</span> instructor</span><br><span class="line"> <span class="keyword">WHERE</span> dept_name <span class="operator">=</span> <span class="string">&#x27;Geology&#x27;</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> geo_instructor</span><br></pre></td></tr></table></figure>

<p>这表明，<code>创建某个视图的用户</code> 并不需要 <code>获得该视图上的所有权限</code>。</p>
<p>该 <code>用户</code> 在 <code>该视图上所获得的权限</code> 并不会 <code>多余它已有的权限</code></p>
<blockquote>
<p>即 <code>危险的用户</code> 无法通过 <code>视图</code>，<code>函数</code> 或 <code>过程</code> 来 <code>获得</code> <code>超越它本有的权限</code> 的 <code>权限</code></p>
</blockquote>
<h3 id="Reference-Authorization"><a href="#Reference-Authorization" class="headerlink" title="Reference Authorization"></a>Reference Authorization</h3><p><code>用户</code> 在 <code>创建外码</code>时，必须要拥有 <code>被参照关系</code> 的 <code>REFERENCE权限</code>。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GRANT</span> <span class="keyword">REFERENCES</span> (dept_name) <span class="keyword">ON</span> department <span class="keyword">TO</span> Mariano;</span><br></pre></td></tr></table></figure>

<p>一个很关键在原因在于：<code>所创建的外码</code> 会对 <code>被参照关系</code> 的 <code>删除和更新</code> 产生 <code>阻碍</code>。</p>
<p>如果 <code>某个用户</code> <code>创建了许多外码约束</code>，那么那个 <code>被参照关系</code> 在 <code>删除和更新</code> 时会 <code>背负许多毫无意义的外码约束</code>，使得因为 <code>违反外码约束</code> 而 <code>无法进行</code> <code>删除和更新</code>。</p>
<p>因此，<code>只有拥有被参照关系的REFERENCES权限的用户</code> 才可以 <code>创建引用该关系的外码</code>。</p>
<blockquote>
<p>类似地，<code>CHECK约束</code> 和 <code>REFERENCES约束</code> 一样，都要求 <code>用户拥有所引用关系的REFERENCE权限</code></p>
</blockquote>
<h3 id="Transfer-Permission-and-Revoke-Permission"><a href="#Transfer-Permission-and-Revoke-Permission" class="headerlink" title="Transfer Permission and Revoke Permission"></a>Transfer Permission and Revoke Permission</h3><p><code>SQL</code> <code>默认</code> 禁止 <code>转授</code> <code>授予某个用户的权限</code>。</p>
<p>如果希望 <code>授予Amit的SELECT权限</code>，<code>Amit仍然可以转授该权限给其他用户</code>，则使用 <code>WIGH GRANT OPTION</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span> <span class="keyword">ON</span> department <span class="keyword">TO</span> Amit <span class="keyword">WITH</span> <span class="keyword">GRANT</span> OPTION;</span><br></pre></td></tr></table></figure>

<hr>
<p><code>用户</code> 和 <code>角色</code> 之间的 <code>权限授予</code> 用 <code>授权图 (Authorization Graph)</code> 来描述。</p>
<p>考虑如下情况，如果 <code>危险用户A</code> 从 <code>DBA</code> 获得 <code>某权限</code>，然后 <code>危险用户A</code> 将 <code>该权限转授</code> <code>危险用户B</code>。</p>
<p>同时，<code>危险用户B</code> 再将 <code>该权限</code> <code>转授</code> <code>危险用户A</code>。</p>
<p>也就是说，形成了一个 <code>转授环</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">graph TD;</span><br><span class="line">dba((DBA)) --&gt; a((A))</span><br><span class="line">a --&gt; b((B))</span><br><span class="line">b --&gt; a</span><br></pre></td></tr></table></figure>

<p>使用 <code>授权图</code> 可以 <code>处理</code> <code>这种情况</code></p>
<p>我们规定，<code>用户具有权限的充分必要条件</code> 是 从<code>授权图的根节点(DBA)</code> 到 <code>该用户的顶点</code> 之间要存在 <code>路径</code>。</p>
<p>对于上述的情况，当我们 <code>撤销授予用户A的权限</code>时，由于 <code>用户B的权限</code> 是 <code>用户A转授给它的</code>，所以，实际上 <code>撤销的路径为</code> dba \to a \to b</p>
<p>于是 <code>授权图</code> 变成</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">graph TD;</span><br><span class="line">dba((DBA))</span><br><span class="line">a((A))</span><br><span class="line">b((B))</span><br></pre></td></tr></table></figure>

<hr>
<p>可以使用 <code>restrict</code> 来 <code>阻止</code> <code>级联收回</code>，如果 <code>存在级联收回</code>，则 <code>不执行任何收权动作</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">REVOKE</span> <span class="keyword">SELECT</span> <span class="keyword">ON</span> department <span class="keyword">FROM</span> amit, Satoshi RESTRICT</span><br></pre></td></tr></table></figure>

<hr>
<p>如果确实希望 <code>只收回用户A的权限</code>，但 <code>不收回用户A授予用户B的权限</code>。</p>
<p>则不应当使用 <code>上述的权限拓扑</code>，<code>DBA</code> 应当将 <code>权限</code> 授予 <code>角色</code>，然后将 <code>角色</code> 授予 <code>用户</code>。即</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">graph TD;</span><br><span class="line">dba((DBA)) --&gt; role(instructor)</span><br><span class="line">role --&gt; a((A))</span><br><span class="line">role --&gt; b((B))</span><br></pre></td></tr></table></figure>

<p>当需要 <code>仅撤销用户A的权限时</code>，只需要 <code>简单地撤销用户A的角色instructor即可</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">graph TD;</span><br><span class="line">dba((DBA)) --&gt; role(instructor)</span><br><span class="line">a((A))</span><br><span class="line">role --&gt; b((B))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>n.b. 作为一种规范，如果可能的话，<code>权限</code> 应该由 <code>角色</code> 来 <code>授予</code>，而不是由 <code>特定的用户</code> 授予 ！</p>
</blockquote>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/04/28/database-elementary-sql/" rel="prev" title="Database - Elementary SQL">
      <i class="fa fa-chevron-left"></i> Database - Elementary SQL
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/04/29/database-advanced-sql/" rel="next" title="Dtabase - Advanced SQL">
      Dtabase - Advanced SQL <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Intermediate-SQL"><span class="nav-number">1.</span> <span class="nav-text">Intermediate SQL</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Join-Expression"><span class="nav-number">1.1.</span> <span class="nav-text">Join Expression</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Join-Condition"><span class="nav-number">1.1.1.</span> <span class="nav-text">Join Condition</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#natural"><span class="nav-number">1.1.1.1.</span> <span class="nav-text">natural</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#using-attribute-list"><span class="nav-number">1.1.1.2.</span> <span class="nav-text">using attribute_list</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#on"><span class="nav-number">1.1.1.3.</span> <span class="nav-text">on </span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Join-Type"><span class="nav-number">1.1.2.</span> <span class="nav-text">Join Type</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Inner-Join"><span class="nav-number">1.1.2.1.</span> <span class="nav-text">Inner Join</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Outer-Join"><span class="nav-number">1.1.2.2.</span> <span class="nav-text">Outer Join</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#View"><span class="nav-number">1.2.</span> <span class="nav-text">View</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Definition"><span class="nav-number">1.2.1.</span> <span class="nav-text">Definition</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Create-a-view"><span class="nav-number">1.2.2.</span> <span class="nav-text">Create a view</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Materialized-View"><span class="nav-number">1.2.3.</span> <span class="nav-text">Materialized View</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Transaction"><span class="nav-number">1.3.</span> <span class="nav-text">Transaction</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Integrity-Constraint"><span class="nav-number">1.4.</span> <span class="nav-text">Integrity Constraint</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Integrity-Constraint-for-Single-Relation"><span class="nav-number">1.4.1.</span> <span class="nav-text">Integrity Constraint for Single-Relation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Referential-Integrity"><span class="nav-number">1.4.2.</span> <span class="nav-text">Referential Integrity</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Definition-1"><span class="nav-number">1.4.2.1.</span> <span class="nav-text">Definition</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#A-simple-demo"><span class="nav-number">1.4.2.2.</span> <span class="nav-text">A simple demo</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Defer-Integrity-Constraint"><span class="nav-number">1.4.3.</span> <span class="nav-text">Defer Integrity Constraint</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Complex-Check-Constraint"><span class="nav-number">1.4.4.</span> <span class="nav-text">Complex Check Constraint</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Assertion"><span class="nav-number">1.5.</span> <span class="nav-text">Assertion</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Data-Type-and-Pattern"><span class="nav-number">1.6.</span> <span class="nav-text">Data Type and Pattern</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Date-and-Time"><span class="nav-number">1.6.1.</span> <span class="nav-text">Date and Time</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Default-Value"><span class="nav-number">1.6.2.</span> <span class="nav-text">Default Value</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Index"><span class="nav-number">1.6.3.</span> <span class="nav-text">Index</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Big-Object-Type"><span class="nav-number">1.6.4.</span> <span class="nav-text">Big Object Type</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#User-Defined-Type"><span class="nav-number">1.6.5.</span> <span class="nav-text">User Defined Type</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Create-Table-Extension"><span class="nav-number">1.7.</span> <span class="nav-text">Create Table Extension</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Schema-Catalog-and-Environment"><span class="nav-number">1.8.</span> <span class="nav-text">Schema, Catalog and Environment</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Authorization"><span class="nav-number">1.9.</span> <span class="nav-text">Authorization</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Grant-and-Revoke"><span class="nav-number">1.9.1.</span> <span class="nav-text">Grant and Revoke</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Role"><span class="nav-number">1.9.2.</span> <span class="nav-text">Role</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#View-Authorization"><span class="nav-number">1.9.3.</span> <span class="nav-text">View Authorization</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Reference-Authorization"><span class="nav-number">1.9.4.</span> <span class="nav-text">Reference Authorization</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Transfer-Permission-and-Revoke-Permission"><span class="nav-number">1.9.5.</span> <span class="nav-text">Transfer Permission and Revoke Permission</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">John Doe</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">103</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
